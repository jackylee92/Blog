[TOC]

>author：李俊东
>
>startDate：2020-06-03
>
>endDate：0000-00-00

## 功能介绍

> 发票核销逻辑加入我方公司、商品品类
>
> 油费网点账户盘点增加商品品类、我方公司
>
> 发票自动匹配负折扣行处理
>
> 发票导入开票日期支持“/”分隔符

## 优化功能

> OMS服务商发票模块独立
>
> 自动匹配JOB方案修改

## 实现方案

* OMS服务商发票模块独立 

  服务商发票相关方法放入OspInvoice.php中，删除Statement.php中发票相关函数，减少Statement.php控制器过大。方便维护。

  发票相关html文件放入ospinvoice/文件夹中

  修改菜单入口 __服务商发票对照表、服务商发票列表__

  修改函数、变量文件命名规则，添加注释。流程梳理


* 服务商盘点增加我方公司、商品品类

  盘点入口：

  ​	OMS油费网点账户-添加盘点：服务商油费主账户盘点、网点油费盘点。

  ​    网点对帐：并行开发中，网点对帐上线再添加功能上线，待网点对帐上线后预留两天补充该部分再上线；

  我方公司：

  ​	通过盘点对应的结算单中可获取到我方公司

  商品品类：

  ​	数据库：statement.osp_bill_adjust 增加商品字段：

  ​	“商品品类”数据来源：

  ​		从系统获取所有的商品品类列表（匹配时将税务发票中的商品，归类对应到我方系统中商品品类）

  ````mysql
  SELECT cat_id, cat_name FROM common.product_category WHERE delete_flag = 0
  ````

  ​	OMS：

  ​		油费网点账户-添加盘点中增加“商品品类”

  ​		Controller:Oil Function:oilCheckPostAction Html:oilcheck.html

  ​	服务：

  ​		ospBill 增加商品字段，录入osp_bill_adjust表中

  ````mysql
  ALTER TABLE `statement`.`osp_bill_adjust` 
  ADD COLUMN `cat_id` int(11) NOT NULL DEFAULT 0 COMMENT '商品品类ID' AFTER `delete_flag`,
  ADD COLUMN `cat_name` varchar(120) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '' COMMENT '商品品类名称' AFTER `cat_id`;
  ````

* 自动匹配Job方案修改

  将发票匹配、取消、红冲剥离成服务，对外提供三个接口，正在处理的发票加锁。

  OMS后台手动操作发票匹配、红冲、取消 直接调用服务，实时返回结果。

  中台同步过来的发票如果符合自动同步条件，则在Job队列中增加一条任务，状态未处理。定时消费Job列表，调用发票服务对应的接口(匹配、取消、红冲)处理数据，返回该处理结果。

  Job根据服务返回的处理结果：

  ​	当返回结果表示没有结算单匹配时，修改Job更新时间、任务状态(处理中)，其他不做修改；

  ​	当返回结果表示发票金额匹配完：需改更新时间、任务状态(已完成)

  ​	当返回结果表示发票匹配完结算单时，发票还剩余金额需要匹配，修改Job更新时间，任务状态(处理中)，其他不做修改

  在匹配记录列表中记录数据产生所对应的JobId

  每次Job处理结束该任务下次触发为十分钟后，避免Job频率过快使发票锁住时间过长，导致OMS手动操作无法完成。

* 发票自动核销增加商品、我方公司纬度 

  jobOspInvoiceMatch syncOspBill 汇总结算单日明细，纬度加上商品品类、我方公司。

  汇总条件：

  ​	结算单ID、服务商ID、日期、商品品类、我方公司相同的结算单明细，汇总成一条数据。

  匹配条件：

  ​	自动匹配：__(发票商品所属服务商ID==明细汇总服务商ID && 发票商品品类==明细汇总商品品类 && 发票我方公司ID==明细汇总我方公司ID)__ 则可以匹配； 

  ​	手动匹配：__(发票商品所属服务商ID==明细汇总服务商ID && 发票我方公司ID==明细汇总我方公司ID)__ 则可以匹配； 

* 发票、结算单匹配顺序

  红冲发票匹配周期内最新的可匹配结算单

  ​	红冲发票商品先使用负数商品匹配

  非红冲发票匹配周期内最早的可匹配结算单

  ​	非红冲发票商品先使用负数商品匹配

* 发票导入开票日期支持“/”分隔符

  针对日期字段转为时间戳，判断如果不为0则再转为统一日期格式，为0判断为错误数据

### 补充 

​	新增需求：

​		OMS手动匹配为强匹配：(发票商品所属服务商ID==明细汇总服务商ID  && 发票我方公司ID==明细汇总我方公司ID)可以匹配；

​		发票取消匹配，该发票不仅取消已匹配数据，如果自动匹配，也停止自动匹配逻辑；

​		红冲发票导致结算单可匹配金额增加，会出现超过原结算单金额情况，这时OMS点击收票，收票损失为可匹配金额-已匹配金额；

## 主要函数

* 服务匹配接口：支持自动匹配、手动匹配

  | 参数      | 类型   | 是否必填 | 备注                                               |
  | --------- | ------ | -------- | -------------------------------------------------- |
  | invoiceId | int    | 必填     | 需要匹配的发票ID                                   |
  | ospId     | int    | 非必填   | 匹配指定服务商的结算单	不填匹配符合条件的服务商 |
  | startTime | string | 非必填   | 匹配指定开始时间的结算单	不填匹配默认时间周期   |
  | endTime   | string | 非必填   | 匹配指定结束时间的结算单	不填匹配默认时间周期   |
  | amount    | int    | 非必填   | 匹配指定金额	不填匹配发票所有金额               |
  | litre     | int    | 非必填   | 匹配指定升量	不填匹配发票所有升量               |
  | goodsId   | int    | 非必填   | 匹配指定商品	不填匹配发票所有商品               |
  | type      | int    | 必填     | 1:手动匹配 2:自动匹配                              |
  | billId    | int    | 非必填   | 匹配指定结算单 不填匹配发票所有符合条件的结算单    |

  手动匹配：发票商品所属服务商ID==(结算单明细汇总服务商ID || 指定的服务商ID) && 发票我方公司ID==结算单明细汇总我方公司ID

  自动匹配：发票商品所属服务商ID==结算单明细汇总服务商ID && 发票商品品类==结算单明细汇总商品品类 && 发票我方公司ID==结算单明细汇总我方公司ID

* 服务取消接口：

  | 参数      | 类型 | 是否必填 | 备注                                                         |
  | --------- | ---- | -------- | ------------------------------------------------------------ |
  | invoiceId | int  | 必填     | 需要取消的发票ID                                             |
  | ospId     | int  | 非必填   | 取消发票指定服务商的结算单匹配数据	不填则取消该发票所有的服务商的结算单匹配数据 |
  | goodsId   | int  | 非必填   | 取消指定商品的匹配数据	不填取消发票所有商品匹配数据       |

  停止该发票的自动匹配：删除job中该发票的任务

  ````mysql
  UPDATE osp_invoice_match_job SET delete_flag = 1 WHERE invoice_id = {$invoiceId}
  ````

* 服务红冲接口：

  | 参数      | 类型 | 是否必填 | 备注             |
  | --------- | ---- | -------- | ---------------- |
  | invoiceId | int  | 必填     | 需要红冲的发票ID |

  > 产生一条发票的负数发票，因为发票为负数，增加符合条件的结算单第一个明细数据的可匹配额度。
  >
  > 增加结算单可匹配总金额额度 ``osp_invoice_bill_match.amount``和升量``.osp_invoice_bill_match.litre``
  >
  > 记录增加的额度为红冲发票匹配增长
  
  


OMS服务商发票模块独立  涉及页面文件：

| 页面                       | 备注                       | 修改               |
| -------------------------- | -------------------------- | ------------------ |
| ospinvoicelist.html        | 发票列表                   | 修改页面中链接地址 |
| ospinvoiceadd.html         | 发票添加                   | 删除               |
| ospinvoicecancel.html      | 发票作废                   | 修改页面中链接地址 |
| ospinvoicechangeosp.html   | 发票绑定服务商修改         | 修改页面中链接地址 |
| ospinvoicecheck.html       | 发票审核页面               | 修改页面中链接地址 |
| ospinvoicecheckmore.html   | 发票批量审核页面           | 修改页面中链接地址 |
| ospinvoiceconfirmnew.html  | 发票确认页面               | 修改页面中链接地址 |
| ospinvoiceexcel.html       | 发票导入页面               | 修改页面中链接地址 |
| ospinvoicegoods.html       | 发票商品列表页面           | 修改页面中链接地址 |
| ospinvoiceinfo.html        | 发票详情页面               | 修改页面中链接地址 |
| ospinvoicelistcounts.html  | 发票统计页面               | 修改页面中链接地址 |
| ospinvoicematch.html       | 发票匹配页面               | 修改页面中链接地址 |
| ospinvoicematchinfo.html   | 发票匹配详情页面           | 修改页面中链接地址 |
| ospinvoicematchlist.html   | 发票已匹配列表             | 修改页面中链接地址 |
| ospinvoiceredrush.html     | 发票红冲页面               | 修改页面中链接地址 |
| ospinvoicereport.html      | 未知                       | 确定后删除         |
| ospinvoicescheck.html      | 发票批量审核               | 修改页面中链接地址 |
| ospinvoiceupdate.html      | 发票修改页面               | 修改页面中链接地址 |
| invoiceospcontrast.html    | 发票抬头服务商关系列表页面 | 修改页面中链接地址 |
| invoiceospcontrastnew.html | 发票抬头服务商关系增加页面 | 修改页面中链接地址 |
|                            |                            |                    |

​	OMS服务商发票模块独立 涉及函数：

| 函数                            | 备注                         |
| ------------------------------- | ---------------------------- |
| OspInvoiceListAction            | 发票列表页面                 |
| getOspInvoiceListWhere          | 发票列表、统计条件处理       |
| OspInvoiceListCountsAction      | 发票统计页面                 |
| OspInvoiceAddAction             | 发票添加页面                 |
| OspInvoiceExcelAction           | 发票导入                     |
| downloadErrExcel                | 发票导入异常excel下载        |
| getExcelData                    | 获取excel数据                |
| OspInvoiceSaveAction            | 发票添加方法                 |
| ValidateOspInvoiceSave          | 发票添加验证数据             |
| OspInvoiceUpdateAction          | 发票修改页面                 |
| OspInvoiceConfirmAction         | 发票确认                     |
| OspInvoiceCheckAction           | 发票审核页面                 |
| OspInvoiceCheckDoAction         | 发票审核方法                 |
| OspInvoiceCancelAction          | 发票作废页面                 |
| OspInvoiceCancelDoAction        | 发票作废方法                 |
| invoiceOspContrastAction        | 服务商发票对照列表           |
| invoiceOspContrastNewAction     | 服务商发票对照关系添加页面   |
| invoiceOspContrastNewPostAction | 服务商发票对照关系添加方法   |
| invoiceOspContrastStopAction    | 服务商发票对照关系停用       |
| OspInvoiceConfirmNewAction      | 服务商发票批量确认页面       |
| OspInvoiceConfirmPostAction     | 服务商发票批量确认方法       |
| OspInvoiceRedRushAction         | 服务商发票红冲页面           |
| OspInvoiceRedRushPostAction     | 服务商发票红冲方法           |
| OspInvoicesCheckAction          | 服务商发票批量收票页面       |
| OspInvoicesCheckPostAction      | 服务商发票批量收票方法       |
| OspInvoicesCancelAction         | 服务商发票批量作废页面       |
| OspInvoiceInfoAction            | 服务商发票详情页面           |
| OspInvoiceGoodsAction           | 服务商发票商品列表页面       |
| OspInvoiceMatchListAction       | 服务商发票匹配列表页面       |
| ospInvoiceMatchAction           | 服务商发票手动匹配页面       |
| ospInvoiceMatchPostAction       | 服务商发票手动匹配方法       |
| ospInvoiceMatchInfoAction       | 服务商发票匹配详情           |
| ospInvoiceUnMatchAction         | 服务商发票取消匹配方法       |
| ospInvoiceChangeOspAction       | 服务商发票修改绑定服务商页面 |
| ospInvoiceChangeOspPostAction   | 服务商发票修改绑定服务商方法 |
| dun2sheng                       | 多系数吨转升                 |
| toLitre                         | 指定系数转升                 |
| bcdiv100                        | 缩小100倍保留2位小数         |
|                                 |                              |

