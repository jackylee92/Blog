[TOC]

>author：李俊东
>
>startDate：2020-05-08
>
>endDate：0000-00-00

## 功能介绍

> 发票列表优化

* 列表主体改为发票商品；
* 列表添加：价计合税、品类、数量、单位
  * 开票日期：财务中台传过来的数据中没有开票日期？？？本期不做
* 添加通过服务商、油品（汽油、柴油、天然气、其他油品、非油品）搜索
* 柴油单位为“吨”转换为“升” *1176，汽油单位为“吨”转换为“升” *1388
* 新增手工匹配、匹配详情
  * 手工匹配：与发票详情中相同
  * 匹配详情：与发票详情中相同
* 绑定服务商优化：有匹配只展示匹配的服务商、没有匹配则展示当前绑定的服务商

## 实现方案

> 主要流程实现方案
>
> job(定时任务)、server(基础服务)、api(接口)、async(异步)、lock(锁) 使用到的功能提供的功能、实现方案

* 先对比现数据库差距，将无效的表删除，部分字段类型同步

* 列表主体改为发票商品

  statement.php>OspInvoiceListAction修改：

  如果POST参数中有：发票编号num、开票公司company_name、我方公司own_company_id、录入开始时间date_start、录入结束时间date_end、确认状态status、收票状态collect_status 则查询osp_invoice表获取invoice_id列表 做为发票商品主表条件

  如果POST参数中有：服务商名称osp_name 则先查询出符合的服务商ID ``$ospIds``列表，通过列表查询osp_invoice_match_relation中(osp_id IN`` $ospIds`` AND delete_flag=0)的invoice_id列表 作为发票商品主表条件和(match_status=0 AND own_company in ``$ospIds``)
  
  如果POST参数中有：油品sku_type 则通过switch(sku_type)出对应的sky_name名称列表 作为发票商品主表条件
  
  查出商品列表，通过invoice_id查出发票列表，对应添加到到商品详情中
  
  将商品列表中商品为柴油(柴油、柴油【免】)、单位为吨对应升量转换 *1176，单位改为升
  
  将商品列表中商品为汽油(汽油、乙醇汽油)、数量为吨对应升量转换 *1388，单位改为升
  
  列表中绑定服务商，通过invoice_id查询出relation中osp_id，与存入对应的商品中，如果商品没有匹配到osp_id则绑定取当前绑定的服务商，当前服务商没有则为空；
  
* 批量作废 ，collect_status改为4

* 去除之前在relation中添加status=0的方案

* 发票列表添加手工匹配、匹配详情入口

* 优化匹配方案

  * 匹配金额为0，匹配状态应该为未匹配；
  * 将匹配、红冲、取消独立成服务；

### 补充

优化relation表：

````
ALTER TABLE `statement`.`osp_invoice_match_relation`
ADD INDEX `index_invoice_Id`(`invoice_id`) USING BTREE,
ADD INDEX `index_osp_id`(`osp_id`) USING BTREE,
ADD INDEX `index_goods_id`(`goods_id`) USING BTREE;
````



## 主要函数

> 涉及到的函数封装

OspInvoiceListAction：发票列表修改

ospinvoicelist.html：发票列表页面修改

toLitre(type, num)：吨转升 新增 type=1 柴油\*1176 type=2 汽油\*1388



## 注意事项

> 开发中的注意事项