# 第一章

> 本章主要讲MySQL的设计架构，和架构中比较重要的模块作用和简单介绍，还有一些发展史。

## 逻辑架构

__第一层：__

负责MySQL客户端连接时的认证、线程处理、安全等相关；

__第二层：__

绝大多数MySQL的核心服务（查询解析、分析、优化、缓存、内置函数、存储过程、触发器）；

会解析查询，优化、重写查询、决定表的读取顺序，以及选择合适的索引等。

__第三层：__

存储引擎，存储数据，提供给上层服务API，响应上层服务请求；

## 并发控制

__方式：__

读写锁：读锁是共享的，互相不阻塞，也就是说多个用户可以同时回去一个资源的读锁而互不影响。写锁是排他的，也就是说，一个写锁会阻塞其他用户获取写锁和读锁。

__颗粒度：__

表锁：对整张表加锁，开销比较小。当在对表进行些操作时，需要先获取表的写锁，获得写锁后会阻塞其他用户对该表的搜索操作。

行锁：最大程度的支持并发，开销比较大。

## 事务

__特性（ACID）：__

原子性：全部成功/失败。

一致性：事务中的成功失败统一执行。

隔离性：未提交之前对其他事物是不可见的。

持久性：一旦提交，操作的数据将保存如数据库中。

__隔离级别：__

未提交读（READ UNCOMMITTED）：事物中的修改未提交时对其他事物都是可见的【脏读】。实际应用中非常少见。

提交读（READ COMMITTED）：一个事物从开始到提交之前，所做的任何修改对其他事物都是不可见的。

可重复读（REPEATABLE READ）：该级别保证了同一个事物中多次读取同样的记录的结果是一致的。

可串行化（SERIALIZABLE）：最高级别的隔离限制，强制事务以串行之行。避免了幻读、脏读问题，但可能会导致大量的超时和锁竞争的问题。

__死锁：__

两个事务都等待对方释放锁，同时都持有对方需要的锁。

INNODB目前解决方案：将持有最少行级排他锁的事务进行回滚。

__自动提交（AUTOCOMMIT）：__

MySQL默认采用自动提交模式，也就是说，如果不是显式的开始一个事务，则每个查询都会被当作一个事务之行提交操作。

````
// 查看使用的自动提交模式；AUTOCOMMIT=0标示所有的查询都在一个事务中，直到显式的之行COMMIT或者ROLLBACK，事务结束。
SHOW VARIABLES LIKE 'AUTOCOMMIT'	
````

对非事务型的表是无效的。比如MyISAM或者内存表

## 多版本并发控制

乐观/悲观并发控制：通过在每行记录后面保存两个隐藏的列来实现。一个保存了行的创建时间，一个保存行的过期时间。作为数据的版本号，事务开始时记录版本号，在事务结束时对比版本号。

Select：查找删除版本号大于当前事务版本（保证该事务时，该数据未被删除）和未删除的数据版本号早于当前事务版本（保证查到的数据时该版本该之前状态）的数据；

Insert：为新插入的每一行数据保存当前系统版本号作为版本号；

Delete：为删除的每一行数据保存当前系统版本号作为行删除标示；

Update；InnoDB为插入一行新数据，保存当前系统版本号作为行版本号，同时保存但前系统版本号到原来的行作为删除标示；

__保存这两个版本号，使大多数读操作都可以不加锁__

## 存储引擎

.frm：保存表的定义

````
// 查看表信息
SHOW TABLE STATUS LIKE "tableName"
````

Name：表名

Engine：表的存储引擎

Row_format：行格式

Rows：表中的行数

Avg_row_length：平均每行包含的字节数

Data_length：表数据的大小

Max_data_length：表数据的最大容量，该值和存储引擎有关

Index_length：索引的大小

Data_free：标示已分配但目前未使用的空间

Auto_increment：下一个AUTO_INCREMENT的值

Create_time：表的创建时间

Update_time：表的最后修改时间

Check_time：使用CHECK TABLE命令或者Myisamchk工具左后一次检查表的时间

Collation：表的默认字符集和字符列排序规则

Checksum：如果启用，保存的事整个表的实施校验和

Create_options：创建表时制定的其他选项

Comment：包含一些其他额外信息

* INNODB：
* MyISAM：

